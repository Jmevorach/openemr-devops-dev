# ============================================================================
# Container Benchmarking Docker Compose Configuration
# ============================================================================
# This compose file sets up the benchmarking environment with:
#   - Two MySQL databases (one for each OpenEMR container to avoid conflicts)
#   - Two OpenEMR containers to compare (Image A and Image B)
#   - Load generator container (for performance testing)
#
# Usage: See README.md for instructions
# ============================================================================

version: '3.8'

services:
  # MySQL Database for Image A
  mysql-a:
    image: mariadb:11.4
    command:
      - mariadbd
      - --character-set-server=utf8mb4
      - --innodb-buffer-pool-size=256M
      - --max-connections=100
    environment:
      MYSQL_ROOT_PASSWORD: root
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized"]
      start_period: 1m
      start_interval: 10s
      interval: 1m
      timeout: 5s
      retries: 3
    volumes:
      - mysql_a_data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - benchmark-network

  # MySQL Database for Image B
  mysql-b:
    image: mariadb:11.4
    command:
      - mariadbd
      - --character-set-server=utf8mb4
      - --innodb-buffer-pool-size=256M
      - --max-connections=100
    environment:
      MYSQL_ROOT_PASSWORD: root
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh", "--su-mysql", "--connect", "--innodb_initialized"]
      start_period: 1m
      start_interval: 10s
      interval: 1m
      timeout: 5s
      retries: 3
    volumes:
      - mysql_b_data:/var/lib/mysql
    restart: unless-stopped
    networks:
      - benchmark-network

  # Image A: Local build from repository
  # This container uses the image built from the local Dockerfile
  openemr-image-a:
    build:
      context: ${IMAGE_A_CONTEXT:-../../docker/openemr/7.0.5}
      dockerfile: Dockerfile
    container_name: benchmark-image-a
    ports:
      - "${IMAGE_A_PORT:-8080}:80"
    depends_on:
      mysql-a:
        condition: service_healthy
    environment:
      MYSQL_HOST: mysql-a
      MYSQL_ROOT_PASS: root
      MYSQL_USER: openemr
      MYSQL_PASS: openemr
      MYSQL_DATABASE: openemr
      OE_USER: admin
      OE_PASS: pass
    healthcheck:
      test: ["CMD", "curl", "-fsSLo", "/dev/null", "http://localhost/"]
      start_period: 10m
      start_interval: 2s
      interval: 1m
      timeout: 5s
      retries: 3
    networks:
      - benchmark-network

  # Image B: Public Docker Hub image
  # This container uses the image from Docker Hub
  openemr-image-b:
    image: ${IMAGE_B_IMAGE:-openemr/openemr:7.0.5}
    container_name: benchmark-image-b
    ports:
      - "${IMAGE_B_PORT:-8081}:80"
    depends_on:
      mysql-b:
        condition: service_healthy
    environment:
      MYSQL_HOST: mysql-b
      MYSQL_ROOT_PASS: root
      MYSQL_USER: openemr
      MYSQL_PASS: openemr
      MYSQL_DATABASE: openemr
      OE_USER: admin
      OE_PASS: pass
    healthcheck:
      test: ["CMD", "curl", "-fsSLo", "/dev/null", "http://localhost/"]
      start_period: 10m
      start_interval: 2s
      interval: 1m
      timeout: 5s
      retries: 3
    networks:
      - benchmark-network

  # Load Generator
  # Uses Apache Bench (ab) to generate load for performance testing
  load-generator:
    image: httpd:alpine
    container_name: benchmark-load-generator
    command: sh -c "apk add --no-cache apache2-utils curl && tail -f /dev/null"
    networks:
      - benchmark-network
    depends_on:
      openemr-image-a:
        condition: service_healthy
      openemr-image-b:
        condition: service_healthy

volumes:
  mysql_a_data:
  mysql_b_data:

networks:
  benchmark-network:
    driver: bridge

